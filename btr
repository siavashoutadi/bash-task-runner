#!/bin/bash

# Find the .btr directory by searching upward from the current working directory
findCommandDir() {
    local searchDir="$PWD"
    while [[ "$searchDir" != "/" ]]; do
        if [[ -d "$searchDir/.btr" ]]; then
            echo "$searchDir/.btr"
            return 0
        fi
        searchDir=$(dirname "$searchDir")
    done
    return 1
}

commandDir=$(findCommandDir)
if [[ -z $commandDir ]]; then
    echo "ERROR: Could not find .btr directory in current directory or any parent directory"
    exit 1
fi

ROOT_REPO_DIR=$(dirname "$commandDir")

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

printError() {
    echo -e "${RED}ERROR: $*${NC}" >&2
}

printWarning() {
    echo -e "${YELLOW}WARNING: $*${NC}"
}

printInfo() {
    echo -e "${BLUE}INFO: $*${NC}"
}

printSuccess() {
    echo -e "${GREEN}SUCCESS: $*${NC}"
}

print() {
    echo -e "$*"
}


printUsage() {
    print "Usage: $0 <command> <action> [arguments]"

    if [[ ! -d $commandDir ]]; then
        printWarning "ERROR: No command available in: $commandDir"
        return 1
    fi

    print "Commands:"
    local dirs=$(find $commandDir/* -maxdepth 0 -type d 2>/dev/null)

    if [[ -z $dirs ]]; then
        print "  (no commands available)"
        return 1
    fi

    for dir in $dirs; do
        print "  $(basename $dir)"
    done
}

printSubCommandUsage() {
    command=$1
    cmd=$(basename $1)
    print "Usage: $0 $cmd <subcommand/action> [arguments]"

    actions=$(find $command/* -maxdepth 0 -type f -executable 2>/dev/null)
    commands=$(find $command/* -maxdepth 0 -type d -executable 2>/dev/null)

    if [[ -z $actions && -z $commands ]]; then
        print "  (no actions or subcommands available)"
        exit 1
    fi

    if [[ -n $commands ]]; then
        print "Sub commands:"
        for f in $commands; do
            print "  $(basename $f)"
        done
    fi

    if [[ -n $actions ]]; then
        print "Actions:"
        for f in $actions; do
            print "  $(basename $f)"
        done
    fi
}

runInDocker() {
    docker_image="$1"
    shift
    docker run --rm -it --user "$(id -u):$(id -g)" -v "$ROOT_REPO_DIR":/workspace -w /workspace "$docker_image" "$@"
}

if [ "$#" == "0" ]; then
    printUsage
    exit 1
fi

command="$commandDir/$1"
if [[ ! -d $command ]]; then
    printError "No command available called '$1'!"
    printUsage
    exit 1
fi

while (("$#")); do
    newCommand="$command/$1"

    if [[ -z $action ]]; then
        if [[ -d $newCommand ]]; then
            command=$newCommand
            continue
        fi

        if [[ -f $newCommand && -x $newCommand ]]; then
            action=$1
        fi
    else
        args="$args $1"
    fi

    shift
done

if [[ -z $action ]]; then
    printSubCommandUsage $command
    exit 1
fi

# Export functions to child processes
export -f printError printWarning printInfo printSuccess print runInDocker
export RED GREEN YELLOW BLUE NC ROOT_REPO_DIR

cmd="$command/$action $args"
$cmd
